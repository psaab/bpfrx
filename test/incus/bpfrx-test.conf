interfaces {
    enp6s0 {
        unit 0 {
            family inet {
                address 10.0.1.10/24;
            }
        }
    }
    enp7s0 {
        unit 0 {
            family inet {
                address 10.0.2.10/24;
                filter {
                    input dscp-filter;
                }
            }
            family inet6 {
                filter {
                    input block-ra;
                }
            }
        }
    }
    enp8s0 {
        unit 0 {
            family inet {
                address 10.0.30.10/24;
            }
        }
    }
    enp9s0 {
        unit 0 {
            family inet {
                address 10.0.40.10/24;
            }
        }
    }
    enp10s0f0np0 {
        vlan-tagging;
        unit 50 {
            vlan-id 50;
            family inet {
                dhcp;
            }
            family inet6 {
                dhcpv6-client {
                    client-identifier {
                        duid-type duid-ll;
                    }
                }
            }
        }
    }
}
security {
    flow {
        tcp-mss {
            ipsec-vpn 1350;
        }
        allow-dns-reply;
        allow-embedded-icmp;
    }
    alg {
        dns { disable; }
        ftp { disable; }
    }
    zones {
        security-zone trust {
            interfaces { enp6s0; }
            host-inbound-traffic {
                system-services { ssh; ping; dhcp; }
            }
        }
        security-zone untrust {
            interfaces { enp7s0; }
            host-inbound-traffic {
                system-services { ping; dhcp; }
            }
        }
        security-zone dmz {
            interfaces { enp8s0; }
            host-inbound-traffic {
                system-services { ssh; ping; dhcp; }
            }
        }
        security-zone tunnel {
            interfaces { enp9s0; }
            host-inbound-traffic {
                system-services { ping; dhcp; }
            }
        }
        security-zone wan {
            interfaces { enp10s0f0np0.50; }
            host-inbound-traffic {
                system-services { ping; dhcp; dhcpv6; }
            }
        }
    }
    policies {
        default-policy deny-all;
        from-zone trust to-zone untrust {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; log { session-init; session-close; } }
            }
        }
        from-zone trust to-zone dmz {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone untrust to-zone trust {
            policy allow-dnat-web {
                match {
                    source-address any;
                    destination-address any;
                    application junos-http;
                }
                then { permit; log { session-init; session-close; } }
            }
        }
        from-zone untrust to-zone dmz {
            policy allow-web {
                match {
                    source-address any;
                    destination-address any;
                    application junos-http;
                }
                then { permit; }
            }
        }
        from-zone trust to-zone wan {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; log { session-init; } }
            }
        }
        from-zone untrust to-zone wan {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone dmz to-zone wan {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
    }
    nat {
        source {
            rule-set trust-to-wan {
                from zone trust;
                to zone wan;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set untrust-to-wan {
                from zone untrust;
                to zone wan;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set dmz-to-wan {
                from zone dmz;
                to zone wan;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
        }
        destination {
            pool web-server {
                address 10.0.1.100/32;
                port 80;
            }
            pool web-server-v6 {
                address fd00:1::100/128;
                port 80;
            }
            rule-set untrust-dnat {
                from zone untrust;
                rule web {
                    match {
                        destination-address 10.0.2.10/32;
                        destination-port 8080;
                    }
                    then { destination-nat pool web-server; }
                }
                rule web-v6 {
                    match {
                        destination-address fd00:2::10/128;
                        destination-port 8080;
                    }
                    then { destination-nat pool web-server-v6; }
                }
            }
        }
    }
    screen {
        ids-option untrust-screen {
            tcp { land; syn-flood; }
            icmp { ping-death; }
            ip { source-route-option; }
        }
    }
}
firewall {
    family inet {
        filter dscp-filter {
            term mark-ef {
                from {
                    dscp ef;
                }
                then accept;
            }
            term block-ssh {
                from {
                    protocol tcp;
                    destination-port 22;
                }
                then {
                    log;
                    discard;
                }
            }
            term default {
                then accept;
            }
        }
    }
    family inet6 {
        filter block-ra {
            term block-ra-adv {
                from {
                    icmp-type 134;
                    icmp-code 0;
                }
                then discard;
            }
            term allow-all {
                then accept;
            }
        }
    }
}
routing-options {
    static {
        route 10.0.30.0/24 { next-hop 10.0.30.1; }
        route 10.0.40.0/24 { next-hop 10.0.40.1; }
    }
}
services {
    rpm {
        probe isp-health {
            test icmp-check {
                probe-type icmp-ping;
                target 10.0.2.1;
                probe-interval 5;
                test-interval 30;
                thresholds {
                    successive-loss 3;
                }
            }
        }
    }
    flow-monitoring {
        version9 {
            template v9-flow {
                flow-active-timeout 60;
                flow-inactive-timeout 15;
                template-refresh-rate {
                    seconds 60;
                }
            }
        }
    }
}
system {
    services {
        dhcp-local-server {
            group trust-pool {
                interface enp6s0;
                pool trust-range {
                    subnet 10.0.1.0/24;
                    address-range low 10.0.1.100 high 10.0.1.199;
                    router 10.0.1.10;
                    dns-server 8.8.8.8;
                }
            }
            group untrust-pool {
                interface enp7s0;
                pool untrust-range {
                    subnet 10.0.2.0/24;
                    address-range low 10.0.2.100 high 10.0.2.199;
                    router 10.0.2.10;
                    dns-server 8.8.8.8;
                }
            }
            group dmz-pool {
                interface enp8s0;
                pool dmz-range {
                    subnet 10.0.30.0/24;
                    address-range low 10.0.30.100 high 10.0.30.199;
                    router 10.0.30.10;
                    dns-server 8.8.8.8;
                }
            }
        }
    }
}
forwarding-options {
    sampling {
        instance jf-instance {
            input {
                rate 1;
            }
            family inet {
                output {
                    flow-server 192.168.99.104 {
                        port 4739;
                        version9-template v9-flow;
                    }
                    inline-jflow;
                }
            }
            family inet6 {
                output {
                    flow-server 192.168.99.104 {
                        port 4739;
                        version9-template v9-flow;
                    }
                    inline-jflow;
                }
            }
        }
    }
}
