interfaces {
    mgmt0 {
        unit 0 {
            family inet {
                dhcp;
            }
        }
    }
    trust0 {
        unit 0 {
            family inet {
                address 10.0.1.10/24;
            }
            family inet6 {
                address 2001:559:8585:bf01::1/64;
            }
        }
    }
    untrust0 {
        unit 0 {
            family inet {
                address 10.0.2.10/24;
                filter {
                    input dscp-filter;
                }
            }
            family inet6 {
                address 2001:559:8585:bf02::1/64;
                filter {
                    input block-ra;
                }
            }
        }
    }
    dmz0 {
        unit 0 {
            family inet {
                address 10.0.30.10/24;
            }
            family inet6 {
                address 2001:559:8585:bf03::1/64;
            }
        }
    }
    tunnel0 {
        unit 0 {
            family inet {
                address 10.0.40.10/24;
            }
        }
    }
    loss0 {
        unit 0 {
            family inet {
                address 10.100.100.1/24;
            }
        }
    }
    wan0 {
        vlan-tagging;
        unit 50 {
            vlan-id 50;
            family inet {
                address 172.16.50.5/24;
            }
            family inet6 {
                address 2001:559:8585:50::5/64;
            }
        }
    }
}
security {
    flow {
        tcp-mss {
            ipsec-vpn 1350;
        }
        allow-dns-reply;
        allow-embedded-icmp;
    }
    alg {
        dns { disable; }
        ftp { disable; }
    }
    zones {
        security-zone mgmt {
            interfaces { mgmt0; }
            host-inbound-traffic {
                system-services { ssh; ping; dhcp; }
            }
        }
        security-zone trust {
            interfaces { trust0; }
            host-inbound-traffic {
                system-services { ssh; ping; dhcp; dhcpv6; }
            }
        }
        security-zone untrust {
            interfaces { untrust0; }
            host-inbound-traffic {
                system-services { ping; dhcp; dhcpv6; }
            }
        }
        security-zone dmz {
            interfaces { dmz0; }
            host-inbound-traffic {
                system-services { ssh; ping; dhcp; dhcpv6; }
            }
        }
        security-zone tunnel {
            interfaces { tunnel0; }
            host-inbound-traffic {
                system-services { ping; dhcp; }
            }
        }
        security-zone loss {
            interfaces { loss0; }
            host-inbound-traffic {
                system-services { ping; }
            }
        }
        security-zone wan {
            interfaces { wan0.50; }
            host-inbound-traffic {
                system-services { ping; }
            }
        }
    }
    policies {
        default-policy deny-all;
        from-zone trust to-zone untrust {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; log { session-init; session-close; } }
            }
        }
        from-zone trust to-zone dmz {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone untrust to-zone trust {
            policy allow-dnat-web {
                match {
                    source-address any;
                    destination-address any;
                    application junos-http;
                }
                then { permit; log { session-init; session-close; } }
            }
            policy reject-rest {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { reject; }
            }
        }
        from-zone untrust to-zone dmz {
            policy allow-web {
                match {
                    source-address any;
                    destination-address any;
                    application junos-http;
                }
                then { permit; }
            }
        }
        from-zone trust to-zone wan {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; log { session-init; } }
            }
        }
        from-zone untrust to-zone wan {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone dmz to-zone wan {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone tunnel to-zone trust {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone trust to-zone loss {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone untrust to-zone loss {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
        from-zone dmz to-zone loss {
            policy allow-all {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then { permit; }
            }
        }
    }
    nat {
        source {
            rule-set trust-to-untrust {
                from zone trust;
                to zone untrust;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set trust-to-wan {
                from zone trust;
                to zone wan;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set untrust-to-wan {
                from zone untrust;
                to zone wan;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set dmz-to-wan {
                from zone dmz;
                to zone wan;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set trust-to-loss {
                from zone trust;
                to zone loss;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set untrust-to-loss {
                from zone untrust;
                to zone loss;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
            rule-set dmz-to-loss {
                from zone dmz;
                to zone loss;
                rule snat {
                    match { source-address 0.0.0.0/0; }
                    then { source-nat { interface; } }
                }
            }
        }
        destination {
            pool web-server {
                address 10.0.1.100/32;
                port 80;
            }
            pool web-server-v6 {
                address 2001:559:8585:bf01::100/128;
                port 80;
            }
            rule-set untrust-dnat {
                from zone untrust;
                rule web {
                    match {
                        destination-address 10.0.2.10/32;
                        destination-port 8080;
                    }
                    then { destination-nat pool web-server; }
                }
                rule web-v6 {
                    match {
                        destination-address 2001:559:8585:bf02::1/128;
                        destination-port 8080;
                    }
                    then { destination-nat pool web-server-v6; }
                }
            }
        }
        nat64 {
            rule-set v6-to-v4 {
                prefix 64:ff9b::/96;
                source-pool trust-snat;
            }
        }
    }
    screen {
        ids-option untrust-screen {
            tcp { land; syn-flood; }
            icmp { ping-death; }
            ip { source-route-option; }
        }
    }
}
firewall {
    family inet {
        filter dscp-filter {
            term mark-ef {
                from {
                    dscp ef;
                }
                then accept;
            }
            term block-ssh {
                from {
                    protocol tcp;
                    destination-port 22;
                }
                then {
                    log;
                    discard;
                }
            }
            term default {
                then accept;
            }
        }
    }
    family inet6 {
        filter block-ra {
            term block-ra-adv {
                from {
                    icmp-type 134;
                    icmp-code 0;
                }
                then discard;
            }
            term allow-all {
                then accept;
            }
        }
    }
}
routing-instances {
    tunnel-vr {
        instance-type virtual-router;
        interface tunnel0;
        routing-options {
            static {
                route 10.0.50.0/24 { next-hop 10.0.40.1; }
                route 10.0.1.0/24 { next-hop 10.0.40.1; }
            }
        }
    }
}
routing-options {
    static {
        route 0.0.0.0/0 { next-hop 172.16.50.1; }
        route ::/0 {
            next-hop fe80::50 {
                interface wan0.50;
            }
        }
        route 10.0.30.0/24 { next-hop 10.0.30.1; }
        route 10.0.40.0/24 { next-hop 10.0.40.1; }
    }
}
protocols {
    router-advertisement {
        interface trust0 {
            managed-configuration;
            other-stateful-configuration;
            prefix 2001:559:8585:bf01::/64 {
                on-link;
                autonomous;
            }
            dns-server-address 2001:4860:4860::8888;
            dns-server-address 2001:4860:4860::8844;
        }
        interface untrust0 {
            managed-configuration;
            other-stateful-configuration;
            prefix 2001:559:8585:bf02::/64 {
                on-link;
                autonomous;
            }
            dns-server-address 2001:4860:4860::8888;
            dns-server-address 2001:4860:4860::8844;
        }
        interface dmz0 {
            managed-configuration;
            other-stateful-configuration;
            prefix 2001:559:8585:bf03::/64 {
                on-link;
                autonomous;
            }
            dns-server-address 2001:4860:4860::8888;
            dns-server-address 2001:4860:4860::8844;
        }
    }
}
services {
    rpm {
        probe isp-health {
            test icmp-check {
                probe-type icmp-ping;
                target 10.0.2.1;
                probe-interval 5;
                test-interval 30;
                thresholds {
                    successive-loss 3;
                }
            }
        }
    }
    flow-monitoring {
        version9 {
            template v9-flow {
                flow-active-timeout 60;
                flow-inactive-timeout 15;
                template-refresh-rate {
                    seconds 60;
                }
            }
        }
    }
}
event-options {
    policy failover-on-probe-fail {
        events [ ping_test_failed ];
        within 60 {
            trigger on 1;
        }
        attributes-match {
            ping_test_failed.test-owner matches isp-health;
            ping_test_failed.test-name matches icmp-check;
        }
        then {
            change-configuration {
                commands {
                    "set routing-options static route 192.168.222.0/24 discard";
                }
            }
        }
    }
    policy restore-on-probe-success {
        events ping_test_completed;
        within 60 {
            trigger on 1;
        }
        attributes-match {
            ping_test_completed.test-owner matches isp-health;
            ping_test_completed.test-name matches icmp-check;
        }
        then {
            change-configuration {
                commands {
                    "delete routing-options static route 192.168.222.0/24";
                }
            }
        }
    }
}
system {
    services {
        dhcp-local-server {
            group trust-pool {
                interface trust0;
                pool trust-range {
                    subnet 10.0.1.0/24;
                    address-range low 10.0.1.100 high 10.0.1.199;
                    router 10.0.1.10;
                    dns-server 8.8.8.8;
                }
            }
            group untrust-pool {
                interface untrust0;
                pool untrust-range {
                    subnet 10.0.2.0/24;
                    address-range low 10.0.2.100 high 10.0.2.199;
                    router 10.0.2.10;
                    dns-server 8.8.8.8;
                }
            }
            group dmz-pool {
                interface dmz0;
                pool dmz-range {
                    subnet 10.0.30.0/24;
                    address-range low 10.0.30.100 high 10.0.30.199;
                    router 10.0.30.10;
                    dns-server 8.8.8.8;
                }
            }
        }
        dhcpv6-local-server {
            group trust-pool6 {
                interface trust0;
                pool trust-range6 {
                    subnet 2001:559:8585:bf01::/64;
                    address-range low 2001:559:8585:bf01::100 high 2001:559:8585:bf01::1ff;
                    dns-server 2001:4860:4860::8888;
                    dns-server 2001:4860:4860::8844;
                }
            }
            group untrust-pool6 {
                interface untrust0;
                pool untrust-range6 {
                    subnet 2001:559:8585:bf02::/64;
                    address-range low 2001:559:8585:bf02::100 high 2001:559:8585:bf02::1ff;
                    dns-server 2001:4860:4860::8888;
                    dns-server 2001:4860:4860::8844;
                }
            }
            group dmz-pool6 {
                interface dmz0;
                pool dmz-range6 {
                    subnet 2001:559:8585:bf03::/64;
                    address-range low 2001:559:8585:bf03::100 high 2001:559:8585:bf03::1ff;
                    dns-server 2001:4860:4860::8888;
                    dns-server 2001:4860:4860::8844;
                }
            }
        }
    }
    snmp {
        description "bpfrx test firewall";
        location "lab";
        contact "admin@test.local";
        community public {
            authorization read-only;
        }
    }
    backup-router 10.0.1.1 destination 10.0.0.0/8;
}
forwarding-options {
    sampling {
        instance jf-instance {
            input {
                rate 1;
            }
            family inet {
                output {
                    flow-server 192.168.99.104 {
                        port 4739;
                        version9-template v9-flow;
                    }
                    inline-jflow;
                }
            }
            family inet6 {
                output {
                    flow-server 192.168.99.104 {
                        port 4739;
                        version9-template v9-flow;
                    }
                    inline-jflow;
                }
            }
        }
    }
}
